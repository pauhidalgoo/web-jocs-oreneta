<!DOCTYPE html>
<html>
<head>
    <title>Game Timeline</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/scripts.js"></script>
</head>
<body>
    <div class="timeline-container">
        <h1>Game Timeline</h1>
        <ul class="timeline">
            {% for game in games %}
            <li class="game-{{ game.status }} {% if game.status != 'revealed' %}blurred{% endif %}" id="game-{{ game.id }}" id="game-{{ game.id }}">
                <h2>{{ game.name }}</h2>
                <p>Type: {{ game.type }}</p>
                <p>Status: {{ game.status }}</p>
                <div class="game-revealed-content" {% if game.status != 'revealed' %}style="display: none;"{% endif %}>
                    {% if game.status == 'revealed' %}
                    {% if game.name == '1-2-1-2' %}
                    {% set user_team = player_teams|selectattr('game_name', 'equalto', '1-2-1-2')|first %}
                    {% if user_team %}
                        <p>You are in team: {{ user_team.team_name }}</p>
                        <p>Team Members:</p>
                        <ul>
                            {% for member in user_team.members %}
                                <li>{{ member.player_number }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <form action="/register_team" method="post" id="team-registration-form">
                            <input type="hidden" name="game_name" value="{{ game.name }}">
                            <input type="text" name="team_name" placeholder="Team Name" required>
                            
                            <label for="player_search">Search and add team members (4 required):</label>
                            <input type="text" id="player_search" placeholder="Search by player number">
                            <div id="player_suggestions"></div>
                            
                            <div id="selected_players">
                                <!-- Selected players will be displayed here -->
                            </div>
                            
                            <button type="submit" disabled id="register_team_button">Register Team</button>
                        </form>
                        <script>
                            const playerSearchInput = document.getElementById('player_search');
                            const playerSuggestions = document.getElementById('player_suggestions');
                            const selectedPlayers = document.getElementById('selected_players');
                            const registerTeamButton = document.getElementById('register_team_button');
                            let selectedPlayerIds = [];

                            playerSearchInput.addEventListener('input', () => {
                                const searchTerm = playerSearchInput.value;
                                playerSuggestions.innerHTML = '';

                                if (searchTerm.length > 0) {
                                    fetch(`/search_players?q=${searchTerm}`)
                                        .then(response => response.json())
                                        .then(players => {
                                            players.forEach(player => {
                                                if (!selectedPlayerIds.includes(player.id) && player.id !== {{ current_player.id }}) {
                                                    const playerDiv = document.createElement('div');
                                                    playerDiv.textContent = `${player.player_number} (${player.name})`;
                                                    playerDiv.addEventListener('click', () => {
                                                        addPlayerToTeam(player);
                                                    });
                                                    playerSuggestions.appendChild(playerDiv);
                                                }
                                            });
                                        });
                                }
                            });

                            function addPlayerToTeam(player) {
                                selectedPlayerIds.push(player.id);
                                const playerItem = document.createElement('div');
                                playerItem.textContent = `${player.player_number} (${player.name})`;
                                
                                // Add a hidden input for each selected player
                                const hiddenInput = document.createElement('input');
                                hiddenInput.type = 'hidden';
                                hiddenInput.name = 'team_members[]';
                                hiddenInput.value = player.id;
                                playerItem.appendChild(hiddenInput);

                                // Add a remove button
                                const removeButton = document.createElement('button');
                                removeButton.textContent = 'Remove';
                                removeButton.addEventListener('click', () => {
                                    removePlayerFromTeam(player.id, playerItem);
                                });
                                playerItem.appendChild(removeButton);
                                
                                selectedPlayers.appendChild(playerItem);
                                playerSearchInput.value = '';
                                playerSuggestions.innerHTML = '';
                                checkTeamSize();
                            }

                            function removePlayerFromTeam(playerId, playerItem) {
                                selectedPlayerIds = selectedPlayerIds.filter(id => id !== playerId);
                                selectedPlayers.removeChild(playerItem);
                                checkTeamSize();
                            }

                            function checkTeamSize() {
                                if (selectedPlayerIds.length === 4) {
                                    registerTeamButton.disabled = false;
                                } else {
                                    registerTeamButton.disabled = true;
                                }
                            }
                        </script>
                    {% endif %}
                        {% elif game.name == 'Mocador' %}
                            {% set player_mocador_team = player_teams|selectattr('game_name', 'equalto', 'Mocador')|first %}
                            {% if player_mocador_team %}
                                <p>You are in team: {{ player_mocador_team.team_name }}</p>
                            {% else %}
                                <p>Choose a team:</p>
                                {% set mocador_teams = get_mocador_teams() %}  {# Assuming you have a function to fetch teams #}
                                {% for team in mocador_teams %}
                                    <form action="/join_team/{{ team.id }}" method="post">
                                        <button type="submit">{{ team.team_name }}</button>
                                    </form>
                                {% endfor %}
                            {% endif %}
                        {% elif game.name == 'Final: Preguntes' and game.status == 'ongoing' %}
                            <p>Vote for the winner:</p>
                            {% for p in players %}
                            <form action="/vote/{{ p.id }}" method="post">
                                <button type="submit">Vote for {{ p.player_number }}</button>
                            </form>
                            {% endfor %}
                        {% endif %}
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
        <a href="/leaderboard">View Leaderboard</a>
    </div>
</body>
</html>